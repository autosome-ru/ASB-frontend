<div
    class="container-fluid asb-search pb-3 pt-0"
    style="background-color: white"
    [class._restricted]="width === 'restricted'"
    [class._full]="width === 'full'">
    <div class="asb-search__header">
        <h4 style="margin-top: 0.5rem">
            {{isAdvanced ? 'Advanced search' : 'Search'}}
        </h4>
        <a
            joyrideStep="search-adv"
            [stepContent]="stepTemplate"
            [stepContentParams]="getTextByStepName('search-adv')"
            style="margin: 0.5rem 20px 0 auto"
            [routerLink]="'/' + (currentRelease$ | async).url + '/' + (isAdvanced ? '/search/simple' : '/search/advanced')"
            [queryParams]="_convertFormToParams(!isAdvanced)"
        >
            {{isAdvanced ? 'Simple search' : 'Advanced search'}}
        </a>
    </div>
    <form
        [formGroup]="searchForm"
        style="display: flex; align-items: center; flex-wrap: wrap"
    >
        <mat-form-field
            style="margin-right: 15px; overflow: auto"
            class="field-without-hint"
            *ngIf="!isAdvanced"
            joyrideStep="search-by"
            [stepContent]="stepTemplate"
            [stepContentParams]="getTextByStepName('search-by')"
            (next)="searchForm.patchValue({searchBy: 'id'})"
            [prevTemplate]="prevTemplate"
            [nextTemplate]="nextTemplate"
            [doneTemplate]="doneTemplate"
        >
            <mat-label>Search by</mat-label>
            <mat-select
                formControlName="searchBy"
            >
                <mat-option value="id">rs ID</mat-option>
                <mat-option value="pos">Genome position</mat-option>
            </mat-select>
        </mat-form-field>

        <ng-container *ngIf="_checkToDisplay('id')">
            <mat-form-field
                joyrideStep="search-rs"
                [stepContent]="stepTemplate"
                [stepContentParams]="getTextByStepName('search-rs')"
                (next)="searchForm.patchValue({searchBy: 'pos', chr: 'chr1'})"
                floatLabel="always"
                style="padding: 0; margin-right: 15px; width: 230px; margin-top: 0.8em;  overflow: auto"
                appearance="outline"
                class="search-field field-without-hint"
            >
                    <input placeholder="e.g. rs28372852"
                           matInput
                           name="Search SNPs"
                           aria-label="search"
                           formControlName="searchInput"
                    >
                <button
                    type="submit"
                    style="display:none"
                    (click)="_navigateToSearch()"
                >hidden submit</button>
                <button
                    mat-icon-button
                    [hidden]="!searchForm.get('searchInput').value"
                    matSuffix
                    style="height: 100%; width: 100%"
                    (click)="_clearSearchField()"
                >
                    <mat-icon svgIcon="clear"></mat-icon>
                </button>

            </mat-form-field>
        </ng-container>

        <div
            style="display: inline-flex;overflow: auto; flex-wrap: wrap; align-items: center"
            *ngIf="_checkToDisplay('pos')"
            joyrideStep="search-pos"
            [stepContent]="stepTemplate"
            [prevTemplate]="prevTemplate"
            [nextTemplate]="nextTemplate"
            [doneTemplate]="doneTemplate"
            (prev)="searchById()"
            [stepContentParams]="getTextByStepName('search-pos',isAdvanced? 'advanced' : 'search')"
        >
            <mat-form-field
                style="width: 100px; margin-right: 15px;"
                floatLabel="always"
                class="field-without-hint"
            >
                <mat-label>Chromosome</mat-label>
                <mat-select
                    formControlName="chromosome"
                >
                    <mat-option *ngIf="isAdvanced" [value]="'any chr'">any chr</mat-option>
                    <mat-option
                        *ngFor="let chr of listOfChrs"
                                [value]="chr"
                    >
                        {{chr}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field
                floatLabel="always"
                style="padding: 0; margin-right: 15px; margin-top: 0.8em; max-width: 230px; width:230px"
                appearance="outline"
                class="search-field search-field-hint"
            >
                <input
                    placeholder="e.g. 28554168-80422458"
                    matInput
                    name="Search SNPs"
                    aria-label="search"
                    formControlName="searchInput"
                >
                <button
                    type="submit"
                    style="display:none"
                    (click)="_navigateToSearch()"
                >
                    hidden submit
                </button>

                <button
                    mat-icon-button
                    [hidden]="!searchForm.get('searchInput').value || searchForm.get('searchInput').disabled"
                    matSuffix
                    style="height: 100%; width: 100%"
                    (click)="_clearSearchField()"
                >
                    <mat-icon svgIcon="clear"></mat-icon>
                </button>

                <mat-hint
                    *ngIf="searchForm.hasError('wrongPattern')"
                   >
                    * must be from-to
                </mat-hint>
                <mat-hint
                    *ngIf="searchForm.hasError('greater')"
                >
                    * end must be > start
                </mat-hint>
            </mat-form-field>
        </div>


        <div
            *ngIf="!isAdvanced"

            style="display: inline-flex; flex-wrap: wrap; justify-content: space-between; position: relative; top: -3px;"
        >
            <div>
                <button

                    class="asb-search__header-demo mt-3 mt-sm-0"
                    style="margin-right: 15px"
                    mat-raised-button
                    [disabled]="_isSearchDisabled()"
                    (click)="_navigateToSearch()"
                    color="accent"
                >
                    <mat-icon
                        style="margin-left: -5px; margin-right:5px"
                        svgIcon="search"
                    ></mat-icon>
                    Search
                </button>
                <div style="margin-right: 15px; display: inline-block">
                    <div
                        joyrideStep="search-nearby"
                        [stepContent]="stepTemplate"
                        [stepContentParams]="getTextByStepName('search-nearby')"
                        style="padding: 10px; margin: -10px"
                    >
                    <button

                        class="asb-search__header-demo mt-3 mt-sm-0"
                        mat-raised-button
                        matTooltip="+/-100bp"
                        [disabled]="!_checkToDisplay('searchNear')"
                        (click)="_nearbySearch()"
                    >
                        Search SNPs nearby
                    </button>
                    </div>
                </div>
            </div>
            <button
                joyrideStep="search-example"
                [stepContent]="stepTemplate"
                [stepContentParams]="getTextByStepName('search-example')"
                (next)="nextExampleStep()"
                (prev)="searchForm.patchValue({searchBy: 'pos', chr: 'chr1'})"
                *ngIf="!isAdvanced"
                mat-raised-button
                class="mt-3 mt-sm-0"
                style=" margin-left: auto"
                (click)="_initDemo()"
            >
                Example
            </button>
        </div>
        <ng-container *ngIf="_checkToDisplay('tf')">
            <mat-form-field
                joyrideStep="search-tf-list"
                [stepContent]="stepTemplate"
                class="col-12 field-without-hint"
                [stepContentParams]="getTextByStepName('search-tf-list')"
                style="overflow: auto; padding: 0; margin-top: -10px"
            >
                <mat-chip-list #chipListTf aria-label="Transcription factor selection">
                    <mat-chip
                        *ngFor="let option of searchForm.get('tfList').value"
                        selectable
                        removable
                        style="margin: 0 2px 0 0"
                        (removed)="_removeChip(option, 'tf')"
                    >
                        {{option}}
                        <mat-icon matChipRemove svgIcon="clear"></mat-icon>
                    </mat-chip>
                    <input
                        #tfInput
                        placeholder="Transcription factors"
                        matInput
                        name="Search CTs"
                        aria-label="search"
                        formControlName="searchTf"
                        [matAutocomplete]="autoTf"
                        [matChipInputFor]="chipListTf"
                        (matChipInputTokenEnd)="_addChip($event, 'tf')"
                    >
                </mat-chip-list>
                <mat-autocomplete #autoTf="matAutocomplete"
                                  autoActiveFirstOption
                                  (optionSelected)="_selectOption($event, 'tf')"
                >
                    <ng-container *ngIf="!(searchOptionsLoading$ | async).tf">
                        <mat-option *ngFor="let option of (searchOptions$ | async).tf" [value]="option.name">
                            <span>{{option.name + " | "}}</span>
                            <small>&nbsp;Total snps: {{option.aggregatedSnpCount}}</small>
                        </mat-option>
                    </ng-container>
                    <mat-option *ngIf="(searchOptionsLoading$ | async).tf">
                        <mat-spinner
                            matSuffix color="accent"
                            [diameter]="12"
                        ></mat-spinner>
                        Loading...
                    </mat-option>
                </mat-autocomplete>
            </mat-form-field>
        </ng-container>

        <ng-container *ngIf="_checkToDisplay('cl')">
            <mat-form-field
                class="col-12"
                style="overflow: auto; padding: 0; margin: -10px 0"
                joyrideStep="search-cl-list"
                [stepContent]="stepTemplate"
                [stepContentParams]="getTextByStepName('search-cl-list')"
                stepPosition="bottom"
            >
                <mat-chip-list #chipListCl aria-label="Cell type selection">
                    <mat-chip
                        *ngFor="let option of searchForm.get('clList').value"
                        selectable
                        style="margin: 0 2px 0 0"
                        removable
                        (removed)="_removeChip(option, 'cl')"
                    >
                        {{option}}
                        <mat-icon matChipRemove svgIcon="clear"></mat-icon>
                    </mat-chip>
                    <input
                        #clInput
                        placeholder="Cell types"
                        matInput
                        name="Search CTs"
                        aria-label="search"
                        formControlName="searchCl"
                        [matAutocomplete]="autoCl"
                        [matChipInputFor]="chipListCl"
                        (matChipInputTokenEnd)="_addChip($event, 'cl')"
                    >
                </mat-chip-list>
                <mat-autocomplete #autoCl="matAutocomplete"
                                  autoActiveFirstOption
                                  (optionSelected)="_selectOption($event, 'cl')"
                >
                    <ng-container *ngIf="!(searchOptionsLoading$ | async).cl">
                        <mat-option *ngFor="let option of (searchOptions$ | async).cl" [value]="option.name">
                            <span>{{option.name + " | "}}</span>
                            <small>&nbsp;Total snps: {{option.aggregatedSnpCount}}</small>
                        </mat-option>
                    </ng-container>
                    <mat-spinner
                        *ngIf="(searchOptionsLoading$ | async).cl"
                        matSuffix color="accent"
                        [diameter]="12"
                    ></mat-spinner>
                </mat-autocomplete>
            </mat-form-field>
        </ng-container>
        <ng-container *ngIf="_checkToDisplay('concordance')">
            <div
                style="overflow: auto; padding-left: 5px; margin-left: -5px;"
                joyrideStep="search-concordance"
                [stepContent]="hocomocoTemplate"
            >
                <span >Motif Concordance:</span>
                <div class="asb-search__checkboxes">
                    <mat-checkbox
                        *ngFor="let concordance of concordances; let last=last"
                        disableRipple
                        [ngClass]="{'asb-search__checkboxes-checkbox': !last}"
                        [formControlName]="concordance"
                    >
                        {{concordance}}
                    </mat-checkbox>
                </div>
            </div>
        </ng-container>
        <ng-container *ngIf="_checkToDisplay('phenotypes')">
            <div style="overflow: auto; padding-left: 5px; margin-left: -5px;"
                 joyrideStep="search-associations"
                 [stepContent]="stepTemplate"
                 [stepContentParams]="getTextByStepName('search-associations')"
            >
            <span >Genetic associations in:</span>
                <div class="asb-search__checkboxes">
                    <mat-checkbox
                        disableRipple
                        *ngFor="let phenotype of phenotypes; let last=last"
                        [ngClass]="{'asb-search__checkboxes-checkbox': !last}"
                        [formControlName]="phenotype"
                    >
                        {{phenToView[phenotype]}}
                    </mat-checkbox>
                </div>
            </div>
        </ng-container>

        <div
            class="asb-search__search-buttons mt-2 mt-lg-n2"
            style="width: 100%"
        >
            <div style="width: 100%; display: flex; justify-content: space-between">
                <button
                    *ngIf="isAdvanced"
                    class="asb-search__header-demo"
                    style="margin-right: 15px"
                    type="button"
                    mat-raised-button
                    [disabled]="_isSearchDisabled()"
                    (click)="_navigateToSearch()"
                    color="accent"
                >
                    <mat-icon
                        style="margin-left: -5px; margin-right:5px"
                        svgIcon="search"
                    ></mat-icon>
                    Search
                </button>
                <div>
                    <button
                        joyrideStep="search-adv-example"
                        [stepContent]="stepTemplate"
                        (next)="nextExampleStep()"
                        [stepContentParams]="getTextByStepName('search-example')"
                        *ngIf="isAdvanced"
                        mat-raised-button
                        style="margin-right: 5px;"
                        (click)="_initDemo()"
                    >
                        Example
                    </button>
                    <div
                        joyrideStep="search-download"
                        [stepContent]="stepTemplate"
                        [stepContentParams]="getTextByStepName('search-download')"
                        *ngIf="isAdvanced"
                        style="display: inline-flex; overflow: auto">
                        <button

                            mat-stroked-button
                            [color]="'accent'"
                            [disabled]="_isSearchDisabled()"
                            (click)="_getResultsInCsv()"
                        >
                            <span class="d-none d-sm-inline-block">Get search results in TSV</span>
                            <span class="d-sm-none d-inline-block">Get TSV</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<ng-template #stepTemplate let-text=text>
    <asb-step-template [text]="text">

    </asb-step-template>
</ng-template>
<ng-template #prevTemplate>
    <button mat-stroked-button color="accent">Prev</button>
</ng-template>

<ng-template #nextTemplate>
    <button mat-raised-button color="accent">Next</button>
</ng-template>

<ng-template #doneTemplate>
    <button mat-raised-button color="accent">Exit</button>
</ng-template>

<ng-template #hocomocoTemplate>
    <div
        style="text-align: center; white-space: pre-line; padding: 10px 20px 10px 10px"
    >
        SNVs concordance with <a
        rel="noopener noreferrer" target="_blank"
        href="https://hocomoco11.autosome.ru/"
    >
        HOCOMOCO v.11
    </a> motifs
    </div>
</ng-template>
